<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>URUOI æ°´åˆ†ç®¡ç†</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --text:#e8eefc; --muted:#9bb0d0; --line:#24324a;
      --accent:#7bb6ff; --good:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --chip:#0c1322;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #122040, var(--bg)); color:var(--text); }
    header{ padding:16px; max-width:980px; margin:0 auto; display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
    header h1{ margin:0; font-size:18px; letter-spacing:.5px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:var(--chip); color:var(--text); font-size:12px; }
    main{ padding:12px 16px 24px; display:grid; gap:12px; max-width:980px; margin:0 auto; }
    .grid{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr .8fr; } }
    .card{ background: color-mix(in oklab, var(--card) 92%, black 8%); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .card h2{ margin:0 0 10px; font-size:14px; color:#d9e6ff; display:flex; justify-content:space-between; align-items:center; }
    .big{ font-size:28px; font-weight:800; margin:6px 0 0; }
    .muted{ color:var(--muted); font-size:12px; }
    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0; }
    .kpi .box{ border:1px solid var(--line); border-radius:12px; background:var(--chip); padding:10px; }
    .bar{ height:12px; border-radius:999px; background:var(--chip); border:1px solid var(--line); overflow:hidden; }
    .bar > div{ height:100%; width:0%; background: linear-gradient(90deg, var(--accent), #a78bfa); transition: width 0.3s ease; }
    .status{ display:flex; justify-content: space-between; align-items:center; margin-top:8px; }
    .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:var(--chip); color:var(--text); cursor:pointer; }
    button.primary{ background: var(--accent); color: var(--bg); font-weight: bold; border: none; }
    button.bad{ border-color: var(--bad); color: var(--bad); }
    input[type="number"]{ width:100px; padding:10px; border-radius:10px; border:1px solid var(--line); background:var(--chip); color:var(--text); }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{ border-bottom:1px solid var(--line); padding:8px 4px; text-align:left; }
    .overlay{ position:fixed; inset:0; background: rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; padding:16px; z-index:100; }
    .overlay.open{ display:flex; }
    .modal{ width:min(600px, 100%); max-height:80vh; overflow:auto; background: var(--card); border-radius:14px; padding:20px; }
    .mono{ font-family: ui-monospace, monospace; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>URUOI æ°´åˆ†ç®¡ç†</h1>
    <div class="muted">åˆç†çš„ãªæ°´åˆ†è£œçµ¦ã®ãŸã‚ã®è¨ˆæ¸¬ã€‚</div>
  </div>
  <div class="btns">
    <button id="openKnowledge">æœ¬</button>
    <button id="openHistory">å±¥æ­´</button>
    <button id="openSettings">è¨­å®š</button>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>ä»Šæ—¥ã®é€²æ— <span class="pill" id="todayStr"></span></h2>
      <div class="big" id="targetMl">-- ml</div>
      <div class="kpi">
        <div class="box"><div class="muted">æ‘‚å–æ¸ˆã¿</div><div class="big" style="font-size:20px" id="takenMl">0 ml</div></div>
        <div class="box"><div class="muted">æ®‹ã‚Š</div><div class="big" style="font-size:20px" id="remainMl">-- ml</div></div>
      </div>
      <div class="bar"><div id="barFill"></div></div>
      <div class="status">
        <div id="statusMsg" class="muted">ç›®æ¨™ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="pill"><span id="pct">0%</span></div>
      </div>
      <div class="btns" id="quickBtns"></div>
      <div class="btns">
        <input id="customAdd" type="number" placeholder="ml">
        <button class="primary" id="addCustom">è¿½åŠ </button>
        <button id="undo">æˆ»ã™</button>
      </div>
    </section>

    <section class="card">
      <h2>ä»Šæ—¥ã®ãƒ­ã‚°</h2>
      <table id="logTable">
        <thead><tr><th>æ™‚åˆ»</th><th>é‡</th><th>ç´¯è¨ˆ</th></tr></thead>
        <tbody id="logBody"></tbody>
      </table>
    </section>
  </div>
</main>

<div class="overlay" id="knowledgeOverlay">
  <div class="modal">
    <h2>æ°´çŸ¥è­˜ã‚¹ã‚¿ãƒ³ãƒ— <button id="closeKnowledge" style="float:right">é–‰ã˜ã‚‹</button></h2>
    <div class="pill">åé›†: <span id="stampCount">0</span> / 55</div>
    <div id="todayStampText" class="card" style="margin:10px 0; background:var(--chip); font-size:13px; line-height:1.6;">
      ç›®æ¨™é”æˆã§çŸ¥è­˜ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚
    </div>
    <table>
      <thead><tr><th>#</th><th>å†…å®¹</th></tr></thead>
      <tbody id="stampList"></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  const KEY = "uruoi_water_v2";
  const KNOWLEDGE_FACTS = [
    { id: 1,  text: "æˆäººã®6ã€œ7å‰²ãŒè‡ªè¦šã®ãªã„æ°´ä¸è¶³çŠ¶æ…‹ã«ã‚ã‚‹ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 2,  text: "ã€Œå–‰ãŒæ¸‡ã„ãŸã€ã¨æ„Ÿã˜ãŸæ™‚ç‚¹ã§ã€ä½“ã¯ã™ã§ã«è„±æ°´ãŒå§‹ã¾ã£ã¦ã„ã¾ã™ã€‚" },
    { id: 3,  text: "å‘¼å¸ã‚„çš®è†šã‹ã‚‰ã®è’¸ç™ºã ã‘ã§ã€1æ—¥ç´„500mlä»¥ä¸Šã®æ°´åˆ†ãŒå¤±ã‚ã‚Œã¾ã™ã€‚" },
    { id: 4,  text: "ä½“é‡ã®1ã€œ2%ã®æ°´åˆ†ä¸è¶³ã§ã€é›†ä¸­åŠ›ã‚„åˆ¤æ–­åŠ›ãŒä½ä¸‹ã—å§‹ã‚ã¾ã™ã€‚" },
    { id: 5,  text: "æ±—ã‚’ã‹ã‹ãªã„å­£ç¯€ã§ã‚‚ã€å‘¼æ°—ãªã©ã‹ã‚‰æ°´åˆ†ã¯å¤±ã‚ã‚Œç¶šã‘ã¦ã„ã¾ã™ã€‚" },
    { id: 6,  text: "æ…¢æ€§çš„ãªè»½åº¦è„±æ°´ã¯ã€ä½“ãŒæ…£ã‚Œã¦ã—ã¾ã„è‡ªè¦šç—‡çŠ¶ãŒå‡ºã«ãã„ã®ãŒç‰¹å¾´ã§ã™ã€‚" },
    { id: 7,  text: "æ°´åˆ†ãŒè¶³ã‚Šãªã„ã¨ã€ä½“ã¯è¡€æµé‡ã‚„ç™ºæ±—é‡ã‚’æŠ‘ãˆã‚‹ç¯€ç´„ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã¾ã™ã€‚" },
    { id: 8,  text: "åŠ é½¢ã«ã‚ˆã‚Šã€è„³ã®æ¸‡ãã‚’æ„Ÿã˜ã‚‹ã‚»ãƒ³ã‚µãƒ¼ã®æ„Ÿåº¦ãŒä½ä¸‹ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 9,  text: "ä¸€åº¦ã«å¤§é‡ã«é£²ã‚€ã‚ˆã‚Šã€å°åˆ†ã‘ã«é£²ã‚€æ–¹ãŒå¸ååŠ¹ç‡ãŒè‰¯ã„ã§ã™ã€‚" },
    { id: 10, text: "åœ°çƒä¸Šã®æ°´ã®ç´„97ï¼…ã¯æµ·æ°´ã§ã™ã€‚" },
    { id: 11, text: "äººãŒåˆ©ç”¨å¯èƒ½ãªæ·¡æ°´ã¯ã€åœ°çƒå…¨ä½“ã®æ°´ã®0.01ï¼…æœªæº€ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚" },
    { id: 12, text: "æ·¡æ°´ã®ç´„7å‰²ã¯æ°·æ²³ã¨ã—ã¦å­˜åœ¨ã—ã¦ãŠã‚Šã€æ¶²ä½“ã¨ã—ã¦å­˜åœ¨ã™ã‚‹ã®ã¯ç¨€ã§ã™ã€‚" },
    { id: 13, text: "åœ°ä¸‹æ°´ã¯ã€æ•°åå¹´ã‹ã‚‰æ•°åƒå¹´ã‹ã‘ã¦åœ°å±¤ã«è“„ãˆã‚‰ã‚ŒãŸè²´é‡ãªè³‡æºã§ã™ã€‚" },
    { id: 14, text: "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã‚„ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã«ã¯åˆ©å°¿ä½œç”¨ãŒã‚ã‚Šã€æ‘‚å–é‡ä»¥ä¸Šã®æ’å‡ºã‚’æ‹›ãã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 15, text: "å°¿ç®¡çµçŸ³ã®æœ€å¤§ã®äºˆé˜²æ³•ã¯ã€ååˆ†ãªæ°´åˆ†è£œçµ¦ã§å°¿ã‚’è–„ã‚ã‚‹ã“ã¨ã§ã™ã€‚" },
    { id: 16, text: "çµçŸ³ã¯æ°´åˆ†ä¸è¶³ã§å°¿ãŒæ¿ƒç¸®ã•ã‚Œã‚‹ã¨çµæ™¶åŒ–ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚" },
    { id: 17, text: "åœ°è¡¨ã®å·ã‚„æ¹–ã‚ˆã‚Šã‚‚ã€åœ°ä¸‹ã«çœ ã‚‹æ°´ã®æ–¹ãŒåœ§å€’çš„ã«é‡ãŒå¤šã„ã§ã™ã€‚" },
    { id: 18, text: "æ·¡æ°´ã®ä¸­ã§å·ã‚„æ¹–ãªã©ã®åœ°è¡¨æ°´ãŒå ã‚ã‚‹å‰²åˆã¯1ï¼…æœªæº€ã§ã™ã€‚" },
    { id: 19, text: "æ—¥æœ¬ã¯åœ°å½¢ã¨é™æ°´é‡ã«æµã¾ã‚Œã€å¤©ç„¶ã®ã‚éã‚·ã‚¹ãƒ†ãƒ ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹å›½ã§ã™ã€‚" },
    { id: 20, text: "æ£®æ—ã¯ã€Œç·‘ã®ãƒ€ãƒ ã€ã¨å‘¼ã°ã‚Œã€é›¨æ°´ã‚’æµ„åŒ–ã—è“„ãˆã‚‹æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ã€‚" },
    { id: 21, text: "åœ°çƒã®æ°´ã®èµ·æºã¯ã€å®‡å®™ã‹ã‚‰é£›æ¥ã—ãŸå½—æ˜Ÿã‚„éš•çŸ³ã¨ã„ã†èª¬ãŒæœ‰åŠ›ã§ã™ã€‚" },
    { id: 22, text: "åœ°çƒä¸Šã®æµ·æ°´ã®ç·é‡ã¯ã€ç´„140äº¬ãƒˆãƒ³ã¨ã„ã†è«å¤§ãªé‡ã•ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 23, text: "ç¡çœ ä¸­ã®å‘¼å¸ã¨ç™ºæ±—ã§ã€ä¸€æ™©ã«ç´„300ã€œ500mlã®æ°´åˆ†ãŒå¤±ã‚ã‚Œã¾ã™ã€‚" },
    { id: 24, text: "èµ·åºŠæ™‚ã®å€¦æ€ æ„Ÿã¯ã€ç¡çœ ä¸­ã®æ°´åˆ†å–ªå¤±ãŒåŸå› ã§ã‚ã‚‹å ´åˆå¤šã„ã§ã™ã€‚" },
    { id: 25, text: "è»½åº¦ã®è„±æ°´ç—‡çŠ¶ã¨ã—ã¦ã€æ…¢æ€§çš„ãªé ­ç—›ãŒç¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 26, text: "æ°´åˆ†ä¸è¶³ã¯è‡ªå¾‹ç¥çµŒã«å½±éŸ¿ã—ã€ã‚¤ãƒ©ã‚¤ãƒ©ã‚„ä¸å®‰æ„Ÿã®ä¸€å› ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 27, text: "è„³ã®ç´„75ï¼…ã¯æ°´åˆ†ã§æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€è„±æ°´ã«æœ€ã‚‚æ•æ„Ÿãªè‡“å™¨ã®ä¸€ã¤ã§ã™ã€‚" },
    { id: 28, text: "äººé–“ã®æˆäººã®ä½“ã¯ç´„60ï¼…ãŒæ°´åˆ†ã§ã§ãã¦ã„ã¾ã™ã€‚" },
    { id: 29, text: "ä¹³å¹¼å…ã®ä½“ã¯ç´„70ï¼…ä»¥ä¸ŠãŒæ°´åˆ†ã§ã€è„±æ°´ã®ãƒªã‚¹ã‚¯ãŒå¤§äººã‚ˆã‚Šé«˜ã„ã§ã™ã€‚" },
    { id: 30, text: "äººé–“ã¯æ°´ãŒãªã‘ã‚Œã°ã€é€šå¸¸3æ—¥ç¨‹åº¦ã—ã‹ç”Ÿå­˜ã§ããªã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 31, text: "å¤§é›¨ã®éš›ã€æ—¥æœ¬åˆ—å³¶å…¨ä½“ã«é™ã‚‹æ°´ã®é‡ã•ã¯æ•°å„„ãƒˆãƒ³å˜ä½ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 32, text: "æ°´ã¯è’¸ç™ºãƒ»é™é›¨ãƒ»å¾ªç’°ã‚’ç¹°ã‚Šè¿”ã—ã€æ•°å„„å¹´å‰ã‹ã‚‰åœ°çƒä¸Šã‚’å·¡ã£ã¦ã„ã¾ã™ã€‚" },
    { id: 33, text: "æ°´åˆ†ä¸è¶³ã§è¡€æ¶²ã®ç²˜åº¦ãŒä¸ŠãŒã‚‹ã¨ã€é…¸ç´ ã®é‹æ¬åŠ¹ç‡ãŒä¸‹ãŒã‚Šç–²åŠ´æ„ŸãŒå¢—ã—ã¾ã™ã€‚" },
    { id: 34, text: "è„³ã¯ã‚ãšã‹2%ã®æ°´åˆ†ä¸è¶³ã§ã‚‚ã€èªçŸ¥æ©Ÿèƒ½ã«æ”¯éšœã‚’ããŸã—ã¾ã™ã€‚" },
    { id: 35, text: "1æ—¥ã®çµ¦æ°´ç›®å®‰ã¯ã€ä¸€èˆ¬çš„ã«ã€Œä½“é‡(kg) Ã— 35mlã€ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 36, text: "ã‚¾ã‚¦ã¯1æ—¥ã«ç´„100ãƒªãƒƒãƒˆãƒ«ä»¥ä¸Šã®æ°´ã‚’æ‘‚å–ã—ã¾ã™ã€‚" },
    { id: 37, text: "æˆäººã®å¥åº·ãªæ’å°¿å›æ•°ã¯ã€1æ—¥5ã€œ7å›ç¨‹åº¦ãŒç›®å®‰ã§ã™ã€‚" },
    { id: 38, text: "å°¿ã®è‰²ãŒæ¿ƒã„é»„è‰²ã®å ´åˆã€ä½“å†…ã®æ°´åˆ†ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã§ã™ã€‚" },
    { id: 39, text: "å†¬å ´ã¯ç©ºæ°—ã®ä¹¾ç‡¥ã¨æš–æˆ¿ã«ã‚ˆã‚Šã€ç„¡è‡ªè¦šãªè„±æ°´ãŒèµ·ãã‚„ã™ã„å­£ç¯€ã§ã™ã€‚" },
    { id: 40, text: "ç™ºç†±æ™‚ã¯å‘¼å¸æ•°ãŒå¢—ãˆã€é€šå¸¸æ™‚ã‚ˆã‚Šã‚‚å¤šãã®æ°´åˆ†ãŒå¤±ã‚ã‚Œã¾ã™ã€‚" },
    { id: 41, text: "æ°´åˆ†ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹ã¨ã€ç™ºæ±—ã«ã‚ˆã‚‹ä½“æ¸©èª¿ç¯€ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚" },
    { id: 42, text: "åŸå› ä¸æ˜ã®ã ã‚‹ã•ã¯ã€è¡€æµé‡ã®æ¸›å°‘ã«ã‚ˆã‚‹è»½åº¦è„±æ°´ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 43, text: "æ°´åˆ†ã¯é£Ÿç‰©ç¹Šç¶­ã¨å…±ã«ã€è…¸å†…ç’°å¢ƒã‚’æ•´ãˆä¾¿ç§˜ã‚’äºˆé˜²ã—ã¾ã™ã€‚" },
    { id: 44, text: "èµ·åºŠå¾Œã®ä¸€æ¯ã®æ°´ã¯ã€æ¶ˆåŒ–å™¨ç³»ã‚’åˆºæ¿€ã—ä»£è¬ã‚’ã‚¹ã‚¤ãƒƒãƒã‚ªãƒ³ã«ã—ã¾ã™ã€‚" },
    { id: 45, text: "å°±å¯å‰ã®å°‘é‡ã®çµ¦æ°´ã¯ã€ç¡çœ ä¸­ã®è¡€æ¶²ã®ç²˜åº¦ä¸Šæ˜‡ã‚’é˜²ãã¾ã™ã€‚" },
    { id: 46, text: "ç¿’æ…£çš„ãªæ°´åˆ†è£œçµ¦ã¯ã€è„³è¡€ç®¡æ€§é ­ç—›ã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã—ã¾ã™ã€‚" },
    { id: 47, text: "ç©ºè…¹æ„Ÿã¨å–‰ã®æ¸‡ãã¯è„³å†…ã§æ··åŒã•ã‚Œã‚„ã™ãã€æ°´ã‚’é£²ã‚€ã¨ç©ºè…¹æ„ŸãŒåã¾ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 48, text: "ååˆ†ãªå¾ªç’°è¡€æµé‡ã¯ã€è¡€åœ§ã®æ€¥æ¿€ãªå¤‰å‹•ã‚’å®‰å®šã•ã›ã‚‹åŠ©ã‘ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 49, text: "æ°´åˆ†ä¸è¶³ã¯ã€é‹è»¢æ™‚ã®ãƒŸã‚¹ã‚„åå¿œé€Ÿåº¦ã®ä½ä¸‹ã«ç›´çµã™ã‚‹ã“ã¨ãŒç ”ç©¶ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 50, text: "æ°´ã¯æ „é¤Šç´ ã‚„è€å»ƒç‰©ã‚’é‹æ¬ã™ã‚‹ã€ä½“å†…æœ€å¤§ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚" },
    { id: 51, text: "å†·ãˆæ€§ã®åŸå› ã®ä¸€ã¤ã«ã€æ°´åˆ†ä¸è¶³ã«ã‚ˆã‚‹æœ«æ¢¢è¡€æµã®æ‚ªåŒ–ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 52, text: "ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ï¼ˆè§£æ¯’ï¼‰ã®ä¸»å½¹ã¯æ±—ã§ã¯ãªãã€è…è‡“ã§ã®å°¿ç”Ÿæˆã¨è‚è‡“ã®æ©Ÿèƒ½ã§ã™ã€‚" },
    { id: 53, text: "ã‚µã‚¦ãƒŠã«ã‚ˆã‚‹æ€¥æ¿€ãªç™ºæ±—ã¯ã€ä½“ã«å¼·ã„ã‚¹ãƒˆãƒ¬ã‚¹è² è·ã‚’ã‹ã‘ã‚‹ã€Œéå¸¸äº‹æ…‹ã€ã§ã™ã€‚" },
    { id: 54, text: "åŒ»å­¦çš„ã«ã¯ã€éåº¦ãªã‚µã‚¦ãƒŠåˆ©ç”¨ã¯è„±æ°´ã‚„è¡€åœ§å¤‰å‹•ã®ãƒªã‚¹ã‚¯ãŒæ‡¸å¿µã•ã‚Œã¾ã™ã€‚" },
    { id: 55, text: "ã‚µã‚¦ãƒŠã®ã€Œæ•´ã†ã€æ„Ÿè¦šã¯ã€æ¥µé™çŠ¶æ…‹ã‹ã‚‰ã®è§£æ”¾ã«ã‚ˆã‚‹è„³å†…éº»è–¬çš„åå¿œã®å´é¢ãŒã‚ã‚Šã¾ã™ã€‚" }
  ];

  const KNOWLEDGE_SERIES = {
    A: [1,2,3,5,6,7,8,9], B: [4,27,34,49], C: [23,24,44,45],
    D: [37,38], E: [15,16], F: [10,11,12,17,18,13,22], G: [53,54,55]
  };
  const SERIES_ORDER = ["A","B","C","D","E","F","G"];

  let state = JSON.parse(localStorage.getItem(KEY)) || {
    profile: { weight: 65, sex: "male" },
    quickAdds: [150, 250, 500],
    daily: {},
    knowledge: { unlocked: [], awardedByDate: {}, seriesIndex: {}, activeSeries: "A" }
  };

  const saveState = () => localStorage.setItem(KEY, JSON.stringify(state));
  const dateKey = () => new Date().toISOString().split('T')[0];

  function getTodayRec() {
    const k = dateKey();
    if (!state.daily[k]) state.daily[k] = { targetMl: 2000, entries: [] };
    return state.daily[k];
  }

  function sumTaken(entries) { return entries.reduce((acc, e) => acc + e.ml, 0); }

  function awardKnowledgeIfAchieved() {
    const today = dateKey();
    if (state.knowledge.awardedByDate[today]) return;
    const rec = getTodayRec();
    const taken = sumTaken(rec.entries);
    if (taken < rec.targetMl) return;

    let id = null;
    for (let s of SERIES_ORDER) {
      const arr = KNOWLEDGE_SERIES[s];
      let idx = state.knowledge.seriesIndex[s] || 0;
      while (idx < arr.length && state.knowledge.unlocked.includes(arr[idx])) idx++;
      if (idx < arr.length) {
        id = arr[idx];
        state.knowledge.seriesIndex[s] = idx + 1;
        state.knowledge.activeSeries = s;
        break;
      }
    }
    if (!id) id = KNOWLEDGE_FACTS.map(f => f.id).find(i => !state.knowledge.unlocked.includes(i));
    
    if (id) {
      state.knowledge.unlocked.push(id);
      state.knowledge.awardedByDate[today] = id;
      saveState();
      const fact = KNOWLEDGE_FACTS.find(f => f.id === id);
      document.getElementById("statusMsg").innerHTML = `ğŸ‰ <b>çŸ¥è­˜#${id}ç²å¾—:</b> ${fact.text}`;
      document.getElementById("statusMsg").style.color = "var(--accent)";
    }
  }

  function render() {
    const rec = getTodayRec();
    const taken = sumTaken(rec.entries);
    const pct = Math.min(100, Math.round((taken / rec.targetMl) * 100));
    
    document.getElementById("targetMl").textContent = `${rec.targetMl} ml`;
    document.getElementById("takenMl").textContent = `${taken} ml`;
    document.getElementById("remainMl").textContent = `${Math.max(0, rec.targetMl - taken)} ml`;
    document.getElementById("pct").textContent = `${pct}%`;
    document.getElementById("barFill").style.width = `${pct}%`;
    document.getElementById("todayStr").textContent = dateKey();

    const logBody = document.getElementById("logBody");
    logBody.innerHTML = "";
    let running = 0;
    rec.entries.forEach(e => {
      running += e.ml;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${new Date(e.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td><td>+${e.ml}</td><td>${running}</td>`;
      logBody.appendChild(tr);
    });

    const quickBtns = document.getElementById("quickBtns");
    quickBtns.innerHTML = "";
    state.quickAdds.forEach(ml => {
      const b = document.createElement("button");
      b.textContent = `+${ml}`;
      b.onclick = () => { rec.entries.push({t:Date.now(), ml}); saveState(); render(); awardKnowledgeIfAchieved(); };
      quickBtns.appendChild(b);
    });
  }

  document.getElementById("addCustom").onclick = () => {
    const ml = parseInt(document.getElementById("customAdd").value);
    if (ml) { getTodayRec().entries.push({t:Date.now(), ml}); saveState(); render(); awardKnowledgeIfAchieved(); }
  };

  document.getElementById("undo").onclick = () => { getTodayRec().entries.pop(); saveState(); render(); };

  document.getElementById("openKnowledge").onclick = () => {
    const k = state.knowledge;
    const todayId = k.awardedByDate[dateKey()];
    document.getElementById("stampCount").textContent = k.unlocked.length;
    document.getElementById("todayStampText").textContent = todayId ? KNOWLEDGE_FACTS.find(f => f.id === todayId).text : "ç›®æ¨™é”æˆã§çŸ¥è­˜è§£æ”¾ã€‚";
    const list = document.getElementById("stampList");
    list.innerHTML = "";
    KNOWLEDGE_FACTS.forEach(f => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="mono">#${f.id}</td><td>${k.unlocked.includes(f.id) ? f.text : "ï¼Ÿï¼Ÿï¼Ÿ"}</td>`;
      list.appendChild(tr);
    });
    document.getElementById("knowledgeOverlay").classList.add("open");
  };

  document.getElementById("closeKnowledge").onclick = () => document.getElementById("knowledgeOverlay").classList.remove("open");

  // Init
  render();
  awardKnowledgeIfAchieved();
  window.addEventListener("focus", awardKnowledgeIfAchieved);
})();
</script>
</body>
</html>
