<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>URUOI æ°´åˆ†ç®¡ç† </title>
  <link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="URUOI">

  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --text:#e8eefc; --muted:#9bb0d0; --line:#24324a;
      --accent:#7bb6ff; --good:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --chip:#0c1322;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #122040, var(--bg)); color:var(--text); }
    header{ padding:16px 16px 10px; max-width:980px; margin:0 auto; display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
    header h1{ margin:0; font-size:18px; letter-spacing:.5px; }
    header .right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:var(--chip); color:var(--text); font-size:12px; }
    main{ padding:12px 16px 24px; display:grid; gap:12px; max-width:980px; margin:0 auto; }
    .grid{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr .8fr; } }
    .card{ background: color-mix(in oklab, var(--card) 92%, black 8%); border:1px solid color-mix(in oklab, var(--line) 85%, white 15%);
      border-radius:14px; padding:14px; box-shadow: 0 10px 28px rgba(0,0,0,.25); }
    .card h2{ margin:0 0 10px; font-size:14px; color:#d9e6ff; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .muted{ color:var(--muted); font-size:12px; }
    .big{ font-size:28px; font-weight:800; margin:6px 0 0; }
    .sub{ color:var(--muted); font-size:12px; margin-top:6px; }
    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .kpi .box{ border:1px solid var(--line); border-radius:12px; background:var(--chip); padding:10px; }
    .kpi .box .t{ font-size:11px; color:var(--muted); }
    .kpi .box .v{ font-size:18px; margin-top:4px; font-weight:700; }
    .bar{ height:12px; border-radius:999px; background:var(--chip); border:1px solid var(--line); overflow:hidden; }
    .bar > div{ height:100%; width:0%; background: linear-gradient(90deg, var(--accent), #a78bfa); }
    .status{ display:flex; justify-content: space-between; align-items:center; gap:10px; margin-top:8px; }
    .status .msg{ font-size:12px; color:var(--muted); }
    .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:var(--chip); color:var(--text); cursor:pointer; }
    button:active{ transform: translateY(1px); }
    button.primary{ background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 55%, var(--chip)), var(--chip));
      border-color: color-mix(in oklab, var(--accent) 35%, var(--line)); }
    button.good{ border-color: color-mix(in oklab, var(--good) 35%, var(--line)); }
    button.warn{ border-color: color-mix(in oklab, var(--warn) 35%, var(--line)); }
    button.bad{ border-color: color-mix(in oklab, var(--bad) 35%, var(--line)); }
    button.ghost{ background:transparent; }
    button:disabled{ opacity:.45; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{ font:inherit; }
    input[type="number"]{ width:140px; padding:10px 10px; border-radius:10px; border:1px solid var(--line); background:var(--chip); color:var(--text); }
    input[type="range"]{ width:220px; }
    select{ padding:10px 10px; border-radius:10px; border:1px solid var(--line); background:var(--chip); color:var(--text); }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th, td{ border-bottom:1px solid var(--line); padding:8px 6px; font-size:12px; }
    th{ text-align:left; color:var(--muted); font-weight:600; }
    .rightText{ text-align:right; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace; }
    .hint{ font-size:12px; color:var(--muted); margin-top:8px; line-height:1.45; }

    /* Modal */
    .overlay{ position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; z-index:50; }
    .overlay.open{ display:flex; }
    .modal{ width:min(920px, 100%); max-height:min(88vh, 920px); overflow:auto; background: color-mix(in oklab, var(--card) 92%, black 8%);
      border:1px solid color-mix(in oklab, var(--line) 85%, white 15%); border-radius:14px; box-shadow: 0 20px 60px rgba(0,0,0,.45); }
    .modalHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line); position:sticky; top:0;
      background: color-mix(in oklab, var(--card) 96%, black 4%); }
    .modalHeader h3{ margin:0; font-size:14px; }
    .modalBody{ padding:14px; display:grid; gap:12px; }
    .twoCol{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width: 900px){ .twoCol{ grid-template-columns: 1fr 1fr; } }

    /* Calendar */
    .calTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .calGrid{ margin-top:10px; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
    .calRow{ display:grid; grid-template-columns: repeat(7, 1fr); }
    .calHead div{ padding:8px 6px; background: #0a1020; border-bottom:1px solid var(--line); font-size:11px; color:var(--muted); text-align:center; }
    .calCell{ min-height:74px; padding:8px 6px; border-right:1px solid var(--line); border-bottom:1px solid var(--line); background:var(--chip); cursor:pointer; }
    .calCell:nth-child(7n){ border-right:none; }
    .calCell.dim{ opacity:.35; cursor:default; }
    .calCell.selected{ outline:2px solid color-mix(in oklab, var(--accent) 70%, white 0%); outline-offset:-2px; }
    .calDay{ font-size:12px; color:#d9e6ff; display:flex; justify-content:space-between; gap:6px; }
    .calMeta{ margin-top:6px; font-size:11px; color:var(--muted); line-height:1.25; }
    .badgeOk{ color:var(--good); }
    .badgeWarn{ color:var(--warn); }
    .badgeBad{ color:var(--bad); }
  </style>
</head>

<body>
<header>
  <div>
    <h1>URUOI æ°´åˆ†ç®¡ç†</h1>
    <div class="muted">ç›®æ¨™ã¯æ™®æ®µã¯éš ã—ã¦ã€å¿…è¦ãªã¨ãã ã‘ã€Œè¨­å®šã€ã§å¤‰æ›´ã€‚å±¥æ­´ã¯ã€Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ã€‚</div>
  </div>
  <div class="right">
    <span class="pill">ä»Šæ—¥ï¼š<span class="mono" id="todayStr"></span></span>
    <button class="primary" id="openKnowledge">æœ¬</button>
    <button class="primary" id="openHistory">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
    <button class="primary" id="openSettings">è¨­å®š</button>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>
        <span>ä»Šæ—¥ã®ç›®æ¨™ / é€²æ—</span>
        <button class="ghost" id="btnEditTarget">ç›®æ¨™å¤‰æ›´</button>
      </h2>

      <div class="big" id="targetMl">-- ml</div>
      <div class="sub" id="targetSub">--</div>

      <div class="kpi">
        <div class="box">
          <div class="t">æ‘‚å–æ¸ˆã¿</div>
          <div class="v" id="takenMl">0 ml</div>
        </div>
        <div class="box">
          <div class="t">æ®‹ã‚Š</div>
          <div class="v" id="remainMl">-- ml</div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="bar"><div id="barFill"></div></div>
      <div class="status">
        <div class="msg" id="statusMsg">â€”</div>
        <div class="pill"><span>é”æˆç‡</span><span class="mono" id="pct">0%</span></div>
      </div>

      <div class="btns" id="quickBtns"></div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>è‡ªç”±å…¥åŠ› (ml)</label>
          <input id="customAdd" type="number" inputmode="numeric" min="1" max="2000" step="1" placeholder="ä¾‹ï¼š180">
        </div>
        <button class="primary" id="addCustom">è¿½åŠ </button>
        <button class="bad" id="undo">ã²ã¨ã¤æˆ»ã™</button>
      </div>

      <div class="btns" style="margin-top:10px">
        <button id="setTaken0">ä»Šæ—¥ã‚’0ã«ã™ã‚‹</button>
        <button id="exportJson">ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—(JSON)</button>
        <button id="importJson">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿(JSON)</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none" />

      <div class="hint" id="modeHint"></div>
    </section>

    <section class="card">
      <h2>ä»Šæ—¥ã®ãƒ­ã‚°</h2>
      <table>
        <thead>
          <tr><th>æ™‚åˆ»</th><th class="rightText">é‡</th><th class="rightText">åˆè¨ˆ</th></tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
      <div class="hint">éå»æ—¥ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠã™ã‚‹ã¨é–²è¦§ã§ãã¾ã™ï¼ˆèª¤æ“ä½œé˜²æ­¢ã§è¿½åŠ ã¯ä¸å¯ï¼‰ã€‚</div>
    </section>
  </div>

  <section class="card">
    <h2>è¨ˆç®—ã®å†…è¨³ï¼ˆä»Šæ—¥ã®ç›®æ¨™ã®åˆ†è§£ï¼‰</h2>
    <div class="row">
      <div class="pill"><span>ãƒ™ãƒ¼ã‚¹</span><span class="mono" id="baseMl">--</span></div>
      <div class="pill"><span>å…¥æµ´åŠ ç®—</span><span class="mono" id="bathAddMl">--</span></div>
      <div class="pill"><span>åˆè¨ˆ</span><span class="mono" id="sumMl">--</span></div>
    </div>
    <div class="hint">
      ãƒ™ãƒ¼ã‚¹ï¼šä½“é‡Ã—ä¿‚æ•°ï¼ˆç”·æ€§35 / å¥³æ€§31 ml/kgï¼‰<br>
      å…¥æµ´åŠ ç®—ï¼šåˆ†Ã—å›æ•°Ã—(æ¨™æº–10ml/åˆ†)Ã—å¼·ã•è£œæ­£ï¼ˆå¼±0.7 / æ¨™æº–1.0 / å¼·1.3ï¼‰
    </div>
  </section>
</main>

<div class="overlay" id="settingsOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="è¨­å®š">
    <div class="modalHeader">
      <h3>è¨­å®šï¼ˆç›®æ¨™è¨ˆç®— / ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ç·¨é›†ï¼‰</h3>
      <div class="btns" style="margin:0">
        <button id="closeSettings">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="twoCol">
        <section class="card" style="box-shadow:none">
          <h2>ç›®æ¨™ã®è¨ˆç®—</h2>
          <div class="row">
            <div>
              <label>æ€§åˆ¥</label>
              <select id="sex">
                <option value="male">ç”·æ€§</option>
                <option value="female">å¥³æ€§</option>
              </select>
            </div>
            <div>
              <label>èº«é•· (cm)ï¼ˆä»Šã¯å‚è€ƒå€¤ï¼‰</label>
              <input id="height" type="number" inputmode="numeric" min="120" max="220" step="1" value="170">
            </div>
            <div>
              <label>ä½“é‡ (kg)</label>
              <input id="weight" type="number" inputmode="numeric" min="30" max="200" step="0.1" value="65">
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <div>
              <label>å…¥æµ´å›æ•° (å›/æ—¥)</label>
              <input id="bathCount" type="number" inputmode="numeric" min="0" max="5" step="1" value="1">
            </div>
            <div>
              <label>å…¥æµ´æ™‚é–“ (åˆ†/å›)</label>
              <input id="bathMin" type="number" inputmode="numeric" min="0" max="180" step="1" value="20">
            </div>
            <div style="min-width: 260px;">
              <label>å…¥æµ´ã®å¼·ã•</label>
              <input id="bathIntensity" type="range" min="0" max="2" step="1" value="1">
              <div class="muted" id="bathIntensityLabel">æ¨™æº–</div>
            </div>
          </div>
          <div class="btns">
            <button class="primary" id="applyTargetToday">è¨ˆç®—çµæœã‚’ã€Œä»Šæ—¥ã®ç›®æ¨™ã€ã«é©ç”¨</button>
            <button id="resetProfile">å…¥åŠ›ã‚’åˆæœŸåŒ–</button>
          </div>
          <div class="kpi">
            <div class="box">
              <div class="t">è¨ˆç®—ï¼šãƒ™ãƒ¼ã‚¹</div>
              <div class="v" id="calcBase">-- ml</div>
            </div>
            <div class="box">
              <div class="t">è¨ˆç®—ï¼šå…¥æµ´åŠ ç®—</div>
              <div class="v" id="calcBath">-- ml</div>
            </div>
          </div>
          <div class="kpi">
            <div class="box" style="grid-column:1 / -1">
              <div class="t">è¨ˆç®—ï¼šåˆè¨ˆï¼ˆ= é©ç”¨ã•ã‚Œã‚‹ç›®æ¨™ï¼‰</div>
              <div class="v" id="calcTotal">-- ml</div>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <div>
              <label>ç›®æ¨™ã‚’æ‰‹å…¥åŠ› (ml)</label>
              <input id="manualTargetMl" type="number" inputmode="numeric" min="500" max="10000" step="10" placeholder="ä¾‹ï¼š2300">
            </div>
            <button class="primary" id="applyManualTargetToday">æ‰‹å…¥åŠ›ã‚’ã€Œä»Šæ—¥ã®ç›®æ¨™ã€ã«é©ç”¨</button>
          </div>
        </section>
        <section class="card" style="box-shadow:none">
          <h2>ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³</h2>
          <div class="row" id="quickEditRow"></div>
          <div class="btns">
            <button class="primary" id="saveQuick">ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’ä¿å­˜</button>
            <button id="resetQuick">åˆæœŸå€¤ã«æˆ»ã™</button>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="historyOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼">
    <div class="modalHeader">
      <h3>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå±¥æ­´ï¼‰</h3>
      <div class="btns" style="margin:0">
        <button id="closeHistory">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="card" style="box-shadow:none">
        <div class="calTop">
          <div class="row" style="margin:0">
            <button id="prevMonth">â†</button>
            <div class="pill"><span class="mono" id="calTitle">----</span></div>
            <button id="nextMonth">â†’</button>
            <button id="jumpToday" class="primary">ä»Šæ—¥ã¸</button>
          </div>
        </div>
        <div class="calGrid" id="calGrid"></div>
        <div class="card" style="box-shadow:none; margin-top:12px">
          <h2>
            <span>é¸æŠæ—¥ï¼š<span class="mono" id="selDate">----</span></span>
            <span class="muted" id="selMode"></span>
          </h2>
          <div class="row">
            <div class="pill"><span>ç›®æ¨™</span><span class="mono" id="selTarget">--</span></div>
            <div class="pill"><span>æ‘‚å–</span><span class="mono" id="selTaken">--</span></div>
            <div class="pill"><span>é”æˆç‡</span><span class="mono" id="selPct">--</span></div>
          </div>
          <table style="margin-top:10px">
            <thead>
              <tr><th>æ™‚åˆ»</th><th class="rightText">é‡</th><th class="rightText">åˆè¨ˆ</th></tr>
            </thead>
            <tbody id="selLogBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="knowledgeOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="æ°´çŸ¥è­˜ã‚¹ã‚¿ãƒ³ãƒ—">
    <div class="modalHeader">
      <h3>æ°´çŸ¥è­˜ã‚¹ã‚¿ãƒ³ãƒ—</h3>
      <div class="btns" style="margin:0">
        <button id="closeKnowledge">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="pill">åé›†: <span id="stampCount" class="mono">0</span> / 55</div>
      <div id="todayStampText" class="card" style="margin:10px 0; background:var(--chip); font-size:13px; line-height:1.6; border:1px dashed var(--line);">
        ä»Šæ—¥ã®ç›®æ¨™é”æˆã§çŸ¥è­˜ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚
      </div>
      <table>
        <thead><tr><th>#</th><th>å†…å®¹</th></tr></thead>
        <tbody id="stampList"></tbody>
      </table>
    </div>
  </div>
</div>

<div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; padding: 0 16px;">
  <button id="exportBackupBtn" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ›¸ãå‡ºã™</button>
  <label>
    <input id="importBackupInput" type="file" accept="application/json" style="display:none;">
    <button id="importBackupBtn" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€</button>
  </label>
</div>

<script>
(() => {
  const KEY = "uruoi_water_v2";

  // --- Knowledge Data ---
  const KNOWLEDGE_FACTS = [
    { id: 1,  text: "æˆäººã®6ã€œ7å‰²ãŒè‡ªè¦šã®ãªã„æ°´ä¸è¶³çŠ¶æ…‹ã«ã‚ã‚‹ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 2,  text: "ã€Œå–‰ãŒæ¸‡ã„ãŸã€ã¨æ„Ÿã˜ãŸæ™‚ç‚¹ã§ã€ä½“ã¯ã™ã§ã«è„±æ°´ãŒå§‹ã¾ã£ã¦ã„ã¾ã™ã€‚" },
    { id: 3,  text: "å‘¼å¸ã‚„çš®è†šã‹ã‚‰ã®è’¸ç™ºã ã‘ã§ã€1æ—¥ç´„500mlä»¥ä¸Šã®æ°´åˆ†ãŒå¤±ã‚ã‚Œã¾ã™ã€‚" },
    { id: 4,  text: "ä½“é‡ã®1ã€œ2%ã®æ°´åˆ†ä¸è¶³ã§ã€é›†ä¸­åŠ›ã‚„åˆ¤æ–­åŠ›ãŒä½ä¸‹ã—å§‹ã‚ã¾ã™ã€‚" },
    { id: 5,  text: "æ±—ã‚’ã‹ã‹ãªã„å­£ç¯€ã§ã‚‚ã€å‘¼æ°—ãªã©ã‹ã‚‰æ°´åˆ†ã¯å¤±ã‚ã‚Œç¶šã‘ã¦ã„ã¾ã™ã€‚" },
    { id: 6,  text: "æ…¢æ€§çš„ãªè»½åº¦è„±æ°´ã¯ã€ä½“ãŒæ…£ã‚Œã¦ã—ã¾ã„è‡ªè¦šç—‡çŠ¶ãŒå‡ºã«ãã„ã®ãŒç‰¹å¾´ã§ã™ã€‚" },
    { id: 7,  text: "æ°´åˆ†ãŒè¶³ã‚Šãªã„ã¨ã€ä½“ã¯è¡€æµé‡ã‚„ç™ºæ±—é‡ã‚’æŠ‘ãˆã‚‹ç¯€ç´„ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã¾ã™ã€‚" },
    { id: 8,  text: "åŠ é½¢ã«ã‚ˆã‚Šã€è„³ã®æ¸‡ãã‚’æ„Ÿã˜ã‚‹ã‚»ãƒ³ã‚µãƒ¼ã®æ„Ÿåº¦ãŒä½ä¸‹ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 9,  text: "ä¸€åº¦ã«å¤§é‡ã«é£²ã‚€ã‚ˆã‚Šã€å°åˆ†ã‘ã«é£²ã‚€æ–¹ãŒå¸ååŠ¹ç‡ãŒè‰¯ã„ã§ã™ã€‚" },
    { id: 10, text: "åœ°çƒä¸Šã®æ°´ã®ç´„97ï¼…ã¯æµ·æ°´ã§ã™ã€‚" },
    { id: 11, text: "äººãŒåˆ©ç”¨å¯èƒ½ãªæ·¡æ°´ã¯ã€åœ°çƒå…¨ä½“ã®æ°´ã®0.01ï¼…æœªæº€ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚" },
    { id: 12, text: "æ·¡æ°´ã®ç´„7å‰²ã¯æ°·æ²³ã¨ã—ã¦å­˜åœ¨ã—ã¦ãŠã‚Šã€æ¶²ä½“ã¨ã—ã¦å­˜åœ¨ã™ã‚‹ã®ã¯ç¨€ã§ã™ã€‚" },
    { id: 13, text: "åœ°ä¸‹æ°´ã¯ã€æ•°åå¹´ã‹ã‚‰æ•°åƒå¹´ã‹ã‘ã¦åœ°å±¤ã«è“„ãˆã‚‰ã‚ŒãŸè²´é‡ãªè³‡æºã§ã™ã€‚" },
    { id: 14, text: "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã‚„ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã«ã¯åˆ©å°¿ä½œç”¨ãŒã‚ã‚Šã€æ‘‚å–é‡ä»¥ä¸Šã®æ’å‡ºã‚’æ‹›ãã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 15, text: "å°¿ç®¡çµçŸ³ã®æœ€å¤§ã®äºˆé˜²æ³•ã¯ã€ååˆ†ãªæ°´åˆ†è£œçµ¦ã§å°¿ã‚’è–„ã‚ã‚‹ã“ã¨ã§ã™ã€‚" },
    { id: 16, text: "çµçŸ³ã¯æ°´åˆ†ä¸è¶³ã§å°¿ãŒæ¿ƒç¸®ã•ã‚Œã‚‹ã¨çµæ™¶åŒ–ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚" },
    { id: 17, text: "åœ°è¡¨ã®å·ã‚„æ¹–ã‚ˆã‚Šã‚‚ã€åœ°ä¸‹ã«çœ ã‚‹æ°´ã®æ–¹ãŒåœ§å€’çš„ã«é‡ãŒå¤šã„ã§ã™ã€‚" },
    { id: 18, text: "æ·¡æ°´ã®ä¸­ã§å·ã‚„æ¹–ãªã©ã®åœ°è¡¨æ°´ãŒå ã‚ã‚‹å‰²åˆã¯1ï¼…æœªæº€ã§ã™ã€‚" },
    { id: 19, text: "æ—¥æœ¬ã¯åœ°å½¢ã¨é™æ°´é‡ã«æµã¾ã‚Œã€å¤©ç„¶ã®ã‚éã‚·ã‚¹ãƒ†ãƒ ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹å›½ã§ã™ã€‚" },
    { id: 20, text: "æ£®æ—ã¯ã€Œç·‘ã®ãƒ€ãƒ ã€ã¨å‘¼ã°ã‚Œã€é›¨æ°´ã‚’æµ„åŒ–ã—è“„ãˆã‚‹æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ã€‚" },
    { id: 21, text: "åœ°çƒã®æ°´ã®èµ·æºã¯ã€å®‡å®™ã‹ã‚‰é£›æ¥ã—ãŸå½—æ˜Ÿã‚„éš•çŸ³ã¨ã„ã†èª¬ãŒæœ‰åŠ›ã§ã™ã€‚" },
    { id: 22, text: "åœ°çƒä¸Šã®æµ·æ°´ã®ç·é‡ã¯ã€ç´„140äº¬ãƒˆãƒ³ã¨ã„ã†è«å¤§ãªé‡ã•ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 23, text: "ç¡çœ ä¸­ã®å‘¼å¸ã¨ç™ºæ±—ã§ã€ä¸€æ™©ã«ç´„300ã€œ500mlã®æ°´åˆ†ãŒå¤±ã‚ã‚Œã¾ã™ã€‚" },
    { id: 24, text: "èµ·åºŠæ™‚ã®å€¦æ€ æ„Ÿã¯ã€ç¡çœ ä¸­ã®æ°´åˆ†å–ªå¤±ãŒåŸå› ã§ã‚ã‚‹å ´åˆãŒå¤šã„ã§ã™ã€‚" },
    { id: 25, text: "è»½åº¦ã®è„±æ°´ç—‡çŠ¶ã¨ã—ã¦ã€æ…¢æ€§çš„ãªé ­ç—›ãŒç¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 26, text: "æ°´åˆ†ä¸è¶³ã¯è‡ªå¾‹ç¥çµŒã«å½±éŸ¿ã—ã€ã‚¤ãƒ©ã‚¤ãƒ©ã‚„ä¸å®‰æ„Ÿã®ä¸€å› ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 27, text: "è„³ã®ç´„75ï¼…ã¯æ°´åˆ†ã§æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€è„±æ°´ã«æœ€ã‚‚æ•æ„Ÿãªè‡“å™¨ã®ä¸€ã¤ã§ã™ã€‚" },
    { id: 28, text: "äººé–“ã®æˆäººã®ä½“ã¯ç´„60ï¼…ãŒæ°´åˆ†ã§ã§ãã¦ã„ã¾ã™ã€‚" },
    { id: 29, text: "ä¹³å¹¼å…ã®ä½“ã¯ç´„70ï¼…ä»¥ä¸ŠãŒæ°´åˆ†ã§ã€è„±æ°´ã®ãƒªã‚¹ã‚¯ãŒå¤§äººã‚ˆã‚Šé«˜ã„ã§ã™ã€‚" },
    { id: 30, text: "äººé–“ã¯æ°´ãŒãªã‘ã‚Œã°ã€é€šå¸¸3æ—¥ç¨‹åº¦ã—ã‹ç”Ÿå­˜ã§ããªã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 31, text: "å¤§é›¨ã®éš›ã€æ—¥æœ¬åˆ—å³¶å…¨ä½“ã«é™ã‚‹æ°´ã®é‡ã•ã¯æ•°å„„ãƒˆãƒ³å˜ä½ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 32, text: "æ°´ã¯è’¸ç™ºãƒ»é™é›¨ãƒ»å¾ªç’°ã‚’ç¹°ã‚Šè¿”ã—ã€æ•°å„„å¹´å‰ã‹ã‚‰åœ°çƒä¸Šã‚’å·¡ã£ã¦ã„ã¾ã™ã€‚" },
    { id: 33, text: "æ°´åˆ†ä¸è¶³ã§è¡€æ¶²ã®ç²˜åº¦ãŒä¸ŠãŒã‚‹ã¨ã€é…¸ç´ ã®é‹æ¬åŠ¹ç‡ãŒä¸‹ãŒã‚Šç–²åŠ´æ„ŸãŒå¢—ã—ã¾ã™ã€‚" },
    { id: 34, text: "è„³ã¯ã‚ãšã‹2%ã®æ°´åˆ†ä¸è¶³ã§ã‚‚ã€èªçŸ¥æ©Ÿèƒ½ã«æ”¯éšœã‚’ããŸã—ã¾ã™ã€‚" },
    { id: 35, text: "1æ—¥ã®çµ¦æ°´ç›®å®‰ã¯ã€ä¸€èˆ¬çš„ã«ã€Œä½“é‡(kg) Ã— 35mlã€ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 36, text: "ã‚¾ã‚¦ã¯1æ—¥ã«ç´„100ãƒªãƒƒãƒˆãƒ«ä»¥ä¸Šã®æ°´ã‚’æ‘‚å–ã—ã¾ã™ã€‚" },
    { id: 37, text: "æˆäººã®å¥åº·ãªæ’å°¿å›æ•°ã¯ã€1æ—¥5ã€œ7å›ç¨‹åº¦ãŒç›®å®‰ã§ã™ã€‚" },
    { id: 38, text: "å°¿ã®è‰²ãŒæ¿ƒã„é»„è‰²ã®å ´åˆã€ä½“å†…ã®æ°´åˆ†ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã§ã™ã€‚" },
    { id: 39, text: "å†¬å ´ã¯ç©ºæ°—ã®ä¹¾ç‡¥ã¨æš–æˆ¿ã«ã‚ˆã‚Šã€ç„¡è‡ªè¦šãªè„±æ°´ãŒèµ·ãã‚„ã™ã„å­£ç¯€ã§ã™ã€‚" },
    { id: 40, text: "ç™ºç†±æ™‚ã¯å‘¼å¸æ•°ãŒå¢—ãˆã€é€šå¸¸æ™‚ã‚ˆã‚Šã‚‚å¤šãã®æ°´åˆ†ãŒå¤±ã‚ã‚Œã¾ã™ã€‚" },
    { id: 41, text: "æ°´åˆ†ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹ã¨ã€ç™ºæ±—ã«ã‚ˆã‚‹ä½“æ¸©èª¿ç¯€ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚" },
    { id: 42, text: "åŸå› ä¸æ˜ã®ã ã‚‹ã•ã¯ã€è¡€æµé‡ã®æ¸›å°‘ã«ã‚ˆã‚‹è»½åº¦è„±æ°´ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 43, text: "æ°´åˆ†ã¯é£Ÿç‰©ç¹Šç¶­ã¨å…±ã«ã€è…¸å†…ç’°å¢ƒã‚’æ•´ãˆä¾¿ç§˜ã‚’äºˆé˜²ã—ã¾ã™ã€‚" },
    { id: 44, text: "æœã®ä¸€æ¯ã®æ°´ã¯ã€æ¶ˆåŒ–å™¨ç³»ã‚’åˆºæ¿€ã—ä»£è¬ã‚’ã‚¹ã‚¤ãƒƒãƒã‚ªãƒ³ã«ã—ã¾ã™ã€‚" },
    { id: 45, text: "å°±å¯å‰ã®å°‘é‡ã®çµ¦æ°´ã¯ã€ç¡çœ ä¸­ã®è¡€æ¶²ã®ç²˜åº¦ä¸Šæ˜‡ã‚’é˜²ãã¾ã™ã€‚" },
    { id: 46, text: "ç¿’æ…£çš„ãªæ°´åˆ†è£œçµ¦ã¯ã€è„³è¡€ç®¡æ€§é ­ç—›ã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã—ã¾ã™ã€‚" },
    { id: 47, text: "ç©ºè…¹æ„Ÿã¨å–‰ã®æ¸‡ãã¯è„³å†…ã§æ··åŒã•ã‚Œã‚„ã™ãã€æ°´ã‚’é£²ã‚€ã¨ç©ºè…¹æ„ŸãŒåã¾ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 48, text: "ååˆ†ãªå¾ªç’°è¡€æµé‡ã¯ã€è¡€åœ§ã®æ€¥æ¿€ãªå¤‰å‹•ã‚’å®‰å®šã•ã›ã‚‹åŠ©ã‘ã«ãªã‚Šã¾ã™ã€‚" },
    { id: 49, text: "æ°´åˆ†ä¸è¶³ã¯ã€é‹è»¢æ™‚ã®ãƒŸã‚¹ã‚„åå¿œé€Ÿåº¦ã®ä½ä¸‹ã«ç›´çµã™ã‚‹ã“ã¨ãŒç ”ç©¶ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚" },
    { id: 50, text: "æ°´ã¯æ „é¤Šç´ ã‚„è€å»ƒç‰©ã‚’é‹æ¬ã™ã‚‹ã€ä½“å†…æœ€å¤§ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚" },
    { id: 51, text: "å†·ãˆæ€§ã®åŸå› ã®ä¸€ã¤ã«ã€æ°´åˆ†ä¸è¶³ã«ã‚ˆã‚‹æœ«æ¢¢è¡€æµã®æ‚ªåŒ–ãŒã‚ã‚Šã¾ã™ã€‚" },
    { id: 52, text: "ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ï¼ˆè§£æ¯’ï¼‰ã®ä¸»å½¹ã¯æ±—ã§ã¯ãªãã€è…è‡“ã§ã®å°¿ç”Ÿæˆã¨è‚è‡“ã®æ©Ÿèƒ½ã§ã™ã€‚" },
    { id: 53, text: "ã‚µã‚¦ãƒŠã«ã‚ˆã‚‹æ€¥æ¿€ãªç™ºæ±—ã¯ã€ä½“ã«å¼·ã„ã‚¹ãƒˆãƒ¬ã‚¹è² è·ã‚’ã‹ã‘ã‚‹ã€Œéå¸¸äº‹æ…‹ã€ã§ã™ã€‚" },
    { id: 54, text: "åŒ»å­¦çš„ã«ã¯ã€éåº¦ãªã‚µã‚¦ãƒŠåˆ©ç”¨ã¯è„±æ°´ã‚„è¡€åœ§å¤‰å‹•ã®ãƒªã‚¹ã‚¯ãŒæ‡¸å¿µã•ã‚Œã¾ã™ã€‚" },
    { id: 55, text: "ã‚µã‚¦ãƒŠã®ã€Œæ•´ã†ã€æ„Ÿè¦šã¯ã€æ¥µé™çŠ¶æ…‹ã‹ã‚‰ã®è§£æ”¾ã«ã‚ˆã‚‹è„³å†…éº»è–¬çš„åå¿œã®å´é¢ãŒã‚ã‚Šã¾ã™ã€‚" }
  ];

  const KNOWLEDGE_SERIES = {
    A: [1,2,3,5,6,7,8,9], B: [4,27,34,49], C: [23,24,44,45],
    D: [37,38], E: [15,16], F: [10,11,12,17,18,13,22], G: [53,54,55]
  };
  const SERIES_ORDER = ["A","B","C","D","E","F","G"];

  const defaultState = () => ({
    profile: { sex:"male", height:170, weight:65, bathCount:1, bathMin:20, bathIntensity:1 },
    quickAdds: [150, 200, 250, 350, 500],
    daily: {},
    knowledge: { unlocked: [], awardedByDate: {}, seriesIndex: {}, activeSeries: "A" }
  });

  const $ = (id) => document.getElementById(id);

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      if(!s.profile) s.profile = defaultState().profile;
      if(!Array.isArray(s.quickAdds)) s.quickAdds = defaultState().quickAdds;
      if(!s.daily) s.daily = {};
      if(!s.knowledge) s.knowledge = defaultState().knowledge;
      return s;
    }catch{
      return defaultState();
    }
  }
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function dateKeyLocal(d=new Date()){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const day=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function parseDateKey(k){
    const [y,m,d] = k.split("-").map(Number);
    return new Date(y, m-1, d);
  }
  function fmtYMD(k){
    const d = parseDateKey(k);
    return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
  }
  function formatTime(ts){
    const d=new Date(ts);
    const hh=String(d.getHours()).padStart(2,"0");
    const mm=String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function clamp(n,min,max){
    n=Number(n);
    if(Number.isNaN(n)) return min;
    return Math.max(min, Math.min(max, n));
  }
  function round10(n){ return Math.round(n/10)*10; }
  function intensityFactor(v){
    v=Number(v);
    if(v===0) return 0.7;
    if(v===2) return 1.3;
    return 1.0;
  }
  function intensityLabel(v){
    v=Number(v);
    if(v===0) return "å¼±ã„ï¼ˆæ±—å°‘ãªã‚ï¼‰";
    if(v===2) return "å¼·ã„ï¼ˆæ±—å¤šã‚ï¼‰";
    return "æ¨™æº–";
  }
  function cupsFromMl(ml){ return ml/200; }

  function computeTarget(profile){
    const w = clamp(profile.weight, 30, 200);
    const coef = (profile.sex === "male") ? 35 : 31;
    const base = w * coef;
    const cnt = clamp(profile.bathCount, 0, 5);
    const min = clamp(profile.bathMin, 0, 180);
    const inten = clamp(profile.bathIntensity, 0, 2);
    const bath = cnt * min * 10 * intensityFactor(inten);
    return {
      baseMl: round10(base),
      bathAddMl: round10(bath),
      totalMl: round10(base + bath)
    };
  }

  function getRecord(k, create=false){
    if(!state.daily[k]){
      if(!create) return null;
      state.daily[k] = { targetMl: null, entries: [] };
    }
    return state.daily[k];
  }
  function sumTaken(entries){
    let t=0;
    for(const e of entries) t += e.ml;
    return t;
  }
  function statusText(taken, target){
    if(!target || target<=0) return "ç›®æ¨™ãŒæœªè¨­å®šã§ã™ï¼ˆè¨­å®šã‹ã‚‰é©ç”¨ã—ã¦ã­ï¼‰";
    const ratio = taken/target;
    if(ratio>=1.0) return "é”æˆã€‚é£²ã¿ã™ãã«ãªã‚‰ãªã„ç¯„å›²ã§OKã€‚";
    if(ratio>=0.7) return "ã‚ã¨å°‘ã—ã€‚ã“ã¾ã‚ã«ã€‚";
    if(ratio>=0.4) return "åŠåˆ†æ‰‹å‰ã€‚ãƒšãƒ¼ã‚¹ä¸Šã’ã¦ã‚‚ã„ã„ã€‚";
    return "åºç›¤ã€‚å°‘é‡ã‚’å›æ•°ã§ã€‚";
  }
  function badgeClass(pct){
    if(pct>=100) return "badgeOk";
    if(pct>=70) return "badgeWarn";
    return "badgeBad";
  }

  // --- Knowledge Functions ---
  function awardKnowledgeIfAchieved() {
    const today = dateKeyLocal();
    if (state.knowledge.awardedByDate[today]) return;
    const rec = getRecord(today, false);
    if(!rec) return;
    const taken = sumTaken(rec.entries);
    const target = rec.targetMl || 0;
    if (target <= 0 || taken < target) return;

    let id = null;
    for (let s of SERIES_ORDER) {
      const arr = KNOWLEDGE_SERIES[s];
      let idx = state.knowledge.seriesIndex[s] || 0;
      while (idx < arr.length && state.knowledge.unlocked.includes(arr[idx])) idx++;
      if (idx < arr.length) {
        id = arr[idx];
        state.knowledge.seriesIndex[s] = idx + 1;
        state.knowledge.activeSeries = s;
        break;
      }
    }
    if (!id) id = KNOWLEDGE_FACTS.map(f => f.id).find(i => !state.knowledge.unlocked.includes(i));
    
    if (id) {
      state.knowledge.unlocked.push(id);
      state.knowledge.awardedByDate[today] = id;
      saveState();
      const fact = KNOWLEDGE_FACTS.find(f => f.id === id);
      const msg = $("statusMsg");
      msg.innerHTML = `ğŸ‰ <b>çŸ¥è­˜#${id}ç²å¾—:</b> ${fact.text}`;
      msg.style.color = "var(--accent)";
    }
  }

  // ====== State ======
  let state = loadState();
  let viewingDateKey = dateKeyLocal();
  let calYearMonth = (() => { const d=new Date(); return {y:d.getFullYear(), m:d.getMonth()}; })();

  // ====== DOM Elements ======
  const todayStr = $("todayStr");
  const targetMlEl = $("targetMl");
  const targetSub = $("targetSub");
  const takenMlEl = $("takenMl");
  const remainMlEl = $("remainMl");
  const pctEl = $("pct");
  const barFill = $("barFill");
  const statusMsg = $("statusMsg");
  const logBody = $("logBody");
  const quickBtns = $("quickBtns");
  const customAdd = $("customAdd");
  const modeHint = $("modeHint");
  const baseMlEl = $("baseMl");
  const bathAddMlEl = $("bathAddMl");
  const sumMlEl = $("sumMl");
  const settingsOverlay = $("settingsOverlay");
  const sex = $("sex");
  const height = $("height");
  const weight = $("weight");
  const bathCount = $("bathCount");
  const bathMin = $("bathMin");
  const bathIntensity = $("bathIntensity");
  const bathIntensityLabelEl = $("bathIntensityLabel");
  const calcBase = $("calcBase");
  const calcBath = $("calcBath");
  const calcTotal = $("calcTotal");
  const quickEditRow = $("quickEditRow");
  const historyOverlay = $("historyOverlay");
  const calTitle = $("calTitle");
  const calGrid = $("calGrid");
  const selDate = $("selDate");
  const selMode = $("selMode");
  const selTarget = $("selTarget");
  const selTaken = $("selTaken");
  const selPct = $("selPct");
  const selLogBody = $("selLogBody");
  const knowledgeOverlay = $("knowledgeOverlay");

  function ensureTodayTarget(){
    const k = dateKeyLocal();
    const rec = getRecord(k, true);
    if(typeof rec.targetMl !== "number" || rec.targetMl<=0){
      const c = computeTarget(state.profile);
      rec.targetMl = c.totalMl;
      saveState();
    }
  }

  function applyProfileToSettings(){
    sex.value = state.profile.sex ?? "male";
    height.value = state.profile.height ?? 170;
    weight.value = state.profile.weight ?? 65;
    bathCount.value = state.profile.bathCount ?? 1;
    bathMin.value = state.profile.bathMin ?? 20;
    bathIntensity.value = state.profile.bathIntensity ?? 1;
    bathIntensityLabelEl.textContent = intensityLabel(bathIntensity.value);
    renderCalcPreview();
  }

  function readProfileFromSettings(){
    state.profile = {
      sex: sex.value,
      height: Number(height.value||0),
      weight: Number(weight.value||0),
      bathCount: Number(bathCount.value||0),
      bathMin: Number(bathMin.value||0),
      bathIntensity: Number(bathIntensity.value||1),
    };
    saveState();
  }

  function renderCalcPreview(){
    const p = {
      sex: sex.value,
      height: Number(height.value||0),
      weight: Number(weight.value||0),
      bathCount: Number(bathCount.value||0),
      bathMin: Number(bathMin.value||0),
      bathIntensity: Number(bathIntensity.value||1),
    };
    bathIntensityLabelEl.textContent = intensityLabel(p.bathIntensity);
    const c = computeTarget(p);
    calcBase.textContent = `${c.baseMl.toLocaleString()} ml`;
    calcBath.textContent = `${c.bathAddMl.toLocaleString()} ml`;
    calcTotal.textContent = `${c.totalMl.toLocaleString()} ml`;
  }

  function renderQuickButtons(){
    quickBtns.innerHTML = "";
    state.quickAdds.forEach((ml, idx) => {
      const b = document.createElement("button");
      b.className = (ml >= 500) ? "warn" : "good";
      b.textContent = `+${Number(ml).toLocaleString()}ml`;
      b.addEventListener("click", () => addDrink(Number(ml)));
      quickBtns.appendChild(b);
    });
  }

  function renderQuickEditor(){
    quickEditRow.innerHTML = "";
    state.quickAdds.forEach((ml, i) => {
      const wrap = document.createElement("div");
      wrap.innerHTML = `<label>ãƒœã‚¿ãƒ³${i+1} (ml)</label><input type="number" inputmode="numeric" min="10" max="2000" step="10" value="${ml}">`;
      quickEditRow.appendChild(wrap);
    });
  }

  function saveQuickFromEditor(){
    const inputs = quickEditRow.querySelectorAll("input");
    const arr = [];
    inputs.forEach(inp => { arr.push(round10(clamp(inp.value, 10, 2000))); });
    state.quickAdds = arr;
    saveState();
    renderQuickButtons();
  }

  function renderLog(rec, tbody){
    tbody.innerHTML = "";
    let running = 0;
    for(const e of rec.entries){
      running += e.ml;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="mono">${formatTime(e.t)}</td><td class="rightText mono">+${e.ml.toLocaleString()} ml</td><td class="rightText mono">${running.toLocaleString()} ml</td>`;
      tbody.appendChild(tr);
    }
    if(rec.entries.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
    }
  }

  function renderMain(){
    ensureTodayTarget();
    const now = new Date();
    todayStr.textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
    const isToday = (viewingDateKey === dateKeyLocal());
    const rec = getRecord(viewingDateKey, isToday);

    if(!rec){
      targetMlEl.textContent = `-- ml`;
      targetSub.textContent = `ãƒ‡ãƒ¼ã‚¿ãªã—`;
      takenMlEl.textContent = `0 ml`;
      remainMlEl.textContent = `-- ml`;
      pctEl.textContent = `0%`;
      barFill.style.width = `0%`;
      statusMsg.textContent = `ãƒ‡ãƒ¼ã‚¿ãªã—`;
      logBody.innerHTML = `<tr><td colspan="3" class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      baseMlEl.textContent = `--`;
      bathAddMlEl.textContent = `--`;
      sumMlEl.textContent = `--`;
      setInteractiveEnabled(false);
      modeHint.textContent = `é–²è¦§ä¸­ï¼š${fmtYMD(viewingDateKey)}ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰`;
      return;
    }

    const taken = sumTaken(rec.entries);
    const target = (typeof rec.targetMl === "number" && rec.targetMl>0) ? rec.targetMl : 0;
    targetMlEl.textContent = `${target.toLocaleString()} ml`;
    targetSub.textContent = `${(target/1000).toFixed(2)} L / ã‚³ãƒƒãƒ—(200ml) ç´„${cupsFromMl(target).toFixed(1)}æ¯`;
    takenMlEl.textContent = `${taken.toLocaleString()} ml`;
    remainMlEl.textContent = `${Math.max(0, target - taken).toLocaleString()} ml`;
    const pct = target ? Math.min(100, Math.round((taken/target)*100)) : 0;
    pctEl.textContent = `${pct}%`;
    barFill.style.width = `${pct}%`;
    statusMsg.textContent = statusText(taken, target);
    renderLog(rec, logBody);
    const c = computeTarget(state.profile);
    baseMlEl.textContent = `${c.baseMl.toLocaleString()} ml`;
    bathAddMlEl.textContent = `${c.bathAddMl.toLocaleString()} ml`;
    sumMlEl.textContent = `${c.totalMl.toLocaleString()} ml`;
    setInteractiveEnabled(isToday);
    modeHint.textContent = isToday ? `å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼šä»Šæ—¥ï¼ˆè¿½åŠ /æˆ»ã™ãŒæœ‰åŠ¹ï¼‰` : `é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼š${fmtYMD(viewingDateKey)}ï¼ˆèª¤æ“ä½œé˜²æ­¢ã®ãŸã‚è¿½åŠ /æˆ»ã™ã¯ç„¡åŠ¹ï¼‰`;
  }

  function setInteractiveEnabled(enabled){
    quickBtns.querySelectorAll("button").forEach(b => b.disabled = !enabled);
    $("addCustom").disabled = !enabled;
    $("undo").disabled = !enabled;
    $("setTaken0").disabled = !enabled;
    customAdd.disabled = !enabled;
  }

  function addDrink(ml){
    if(viewingDateKey !== dateKeyLocal()) return;
    ml = Math.floor(Number(ml));
    if(!Number.isFinite(ml) || ml<=0) return;
    const rec = getRecord(dateKeyLocal(), true);
    rec.entries.push({ t: Date.now(), ml });
    saveState();
    renderMain();
    awardKnowledgeIfAchieved();
  }

  function undoLast(){
    if(viewingDateKey !== dateKeyLocal()) return;
    const rec = getRecord(dateKeyLocal(), true);
    if(rec.entries.length===0) return;
    rec.entries.pop();
    saveState();
    renderMain();
  }

  function resetToday(){
    if(viewingDateKey !== dateKeyLocal()) return;
    delete state.daily[dateKeyLocal()];
    saveState();
    ensureTodayTarget();
    renderMain();
  }

  function buildCalendar(){
    calTitle.textContent = `${calYearMonth.y}/${calYearMonth.m+1}`;
    calGrid.innerHTML = "";
    const head = document.createElement("div");
    head.className = "calRow calHead";
    ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(s => {
      const d=document.createElement("div"); d.textContent=s; head.appendChild(d);
    });
    calGrid.appendChild(head);
    const first = new Date(calYearMonth.y, calYearMonth.m, 1);
    const start = new Date(calYearMonth.y, calYearMonth.m, 1 - first.getDay());
    for(let week=0; week<6; week++){
      const row = document.createElement("div"); row.className = "calRow";
      for(let i=0;i<7;i++){
        const d = new Date(start); d.setDate(start.getDate() + week*7 + i);
        const inMonth = (d.getMonth() === calYearMonth.m);
        const key = dateKeyLocal(d);
        const rec = getRecord(key, false);
        const taken = rec ? sumTaken(rec.entries) : 0;
        const target = rec && typeof rec.targetMl==="number" ? rec.targetMl : 0;
        const pct = (rec && target>0) ? Math.round((taken/target)*100) : 0;
        const cell = document.createElement("div");
        cell.className = "calCell" + (inMonth ? "" : " dim") + (key === viewingDateKey ? " selected" : "");
        cell.innerHTML = `<div class="calDay"><span class="mono">${d.getDate()}</span>${key === dateKeyLocal() ? `<span class="badgeOk mono">ä»Šæ—¥</span>` : ``}</div><div class="calMeta">${rec ? `<div class="mono">${taken.toLocaleString()} / ${target.toLocaleString()} ml</div><div class="${badgeClass(pct)} mono">${pct}%</div>` : `â€”`}</div>`;
        cell.onclick = () => { viewingDateKey = key; renderMain(); buildCalendar(); renderSelectedDay(); };
        row.appendChild(cell);
      }
      calGrid.appendChild(row);
    }
  }

  function renderSelectedDay(){
    selDate.textContent = fmtYMD(viewingDateKey);
    selMode.textContent = (viewingDateKey === dateKeyLocal()) ? "ï¼ˆä»Šæ—¥ï¼šå…¥åŠ›å¯ï¼‰" : "ï¼ˆéå»ï¼šé–²è¦§ï¼‰";
    const rec = getRecord(viewingDateKey, false);
    if(!rec){
      selTarget.textContent = `--`; selTaken.textContent = `--`; selPct.textContent = `--`; selLogBody.innerHTML = `<tr><td colspan="3" class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      return;
    }
    const taken = sumTaken(rec.entries);
    const target = rec.targetMl || 0;
    const pct = target ? Math.round((taken/target)*100) : 0;
    selTarget.textContent = `${target.toLocaleString()} ml`;
    selTaken.textContent = `${taken.toLocaleString()} ml`;
    selPct.textContent = `${pct}%`;
    renderLog(rec, selLogBody);
  }

  // --- Modal Events ---
  const toggle = (el, show) => el.classList.toggle("open", show);
  $("openSettings").onclick = () => { applyProfileToSettings(); renderQuickEditor(); toggle(settingsOverlay, true); };
  $("btnEditTarget").onclick = () => { applyProfileToSettings(); renderQuickEditor(); toggle(settingsOverlay, true); };
  $("closeSettings").onclick = () => toggle(settingsOverlay, false);
  $("openHistory").onclick = () => { const d = parseDateKey(viewingDateKey); calYearMonth = { y: d.getFullYear(), m: d.getMonth() }; buildCalendar(); renderSelectedDay(); toggle(historyOverlay, true); };
  $("closeHistory").onclick = () => toggle(historyOverlay, false);
  $("openKnowledge").onclick = () => {
    const k = state.knowledge;
    const todayId = k.awardedByDate[dateKeyLocal()];
    $("stampCount").textContent = k.unlocked.length;
    $("todayStampText").textContent = todayId ? KNOWLEDGE_FACTS.find(f => f.id === todayId).text : "ä»Šæ—¥ã®ç›®æ¨™é”æˆã§çŸ¥è­˜è§£æ”¾ã€‚";
    const list = $("stampList");
    list.innerHTML = "";
    KNOWLEDGE_FACTS.forEach(f => {
      const tr = document.createElement("tr");
      const unlocked = k.unlocked.includes(f.id);
      tr.innerHTML = `<td class="mono">#${f.id}</td><td style="color:${unlocked?'var(--text)':'var(--muted)'}">${unlocked ? f.text : "ï¼Ÿï¼Ÿï¼Ÿ"}</td>`;
      list.appendChild(tr);
    });
    toggle(knowledgeOverlay, true);
  };
  $("closeKnowledge").onclick = () => toggle(knowledgeOverlay, false);

  $("applyTargetToday").onclick = () => { readProfileFromSettings(); const c = computeTarget(state.profile); getRecord(dateKeyLocal(), true).targetMl = c.totalMl; saveState(); renderMain(); alert("é©ç”¨ã—ã¾ã—ãŸ"); };
  $("applyManualTargetToday").onclick = () => { const ml = round10(clamp($("manualTargetMl").value, 500, 10000)); getRecord(dateKeyLocal(), true).targetMl = ml; saveState(); renderMain(); alert("é©ç”¨ã—ã¾ã—ãŸ"); };
  $("saveQuick").onclick = () => { saveQuickFromEditor(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); };
  $("resetQuick").onclick = () => { state.quickAdds = defaultState().quickAdds; saveState(); renderQuickEditor(); renderQuickButtons(); };
  $("addCustom").onclick = () => { addDrink(customAdd.value); customAdd.value = ""; };
  $("undo").onclick = undoLast;
  $("setTaken0").onclick = () => { if(confirm("åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) resetToday(); };
  $("exportJson").onclick = exportJson;
  $("importJson").onclick = () => $("importFile").click();
  $("importFile").onchange = (e) => { const f = e.target.files?.[0]; if(f) importJson(f); e.target.value = ""; };
  $("prevMonth").onclick = () => { calYearMonth.m--; if(calYearMonth.m<0){calYearMonth.m=11; calYearMonth.y--;} buildCalendar(); };
  $("nextMonth").onclick = () => { calYearMonth.m++; if(calYearMonth.m>11){calYearMonth.m=0; calYearMonth.y++;} buildCalendar(); };
  $("jumpToday").onclick = () => { viewingDateKey = dateKeyLocal(); calYearMonth = {y:new Date().getFullYear(), m:new Date().getMonth()}; renderMain(); buildCalendar(); renderSelectedDay(); };

  // --- Backup Buttons ---
  $("exportBackupBtn").onclick = () => { const blob = new Blob([localStorage.getItem(KEY)], {type:"application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "uruoi_backup.json"; a.click(); };
  $("importBackupBtn").onclick = () => $("importBackupInput").click();
  $("importBackupInput").onchange = (e) => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = () => { localStorage.setItem(KEY, r.result); alert("å†èª­ã¿è¾¼ã¿ã—ã¾ã™"); location.reload(); }; r.readAsText(f); };

  function exportJson(){ const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "uruoi_water_backup_v2.json"; a.click(); }
  function importJson(file){ const r = new FileReader(); r.onload = () => { try{ state = JSON.parse(r.result); saveState(); location.reload(); }catch{ alert("å¤±æ•—"); }}; r.readAsText(file); }

  // Init
  renderQuickButtons();
  renderMain();
  awardKnowledgeIfAchieved();
  window.addEventListener("focus", awardKnowledgeIfAchieved);
})();
</script>
</body>
</html>
